name: Build and Deploy to Nexus

on:
    repository_dispatch:
        types: [dispatch-event]

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                java-version: '17'
                distribution: 'adopt'
                cache: maven
            - name: Bump version in pom.xml
              run: |
                   VERSION=$(grep "<version>" pom.xml | head -1 | sed -e 's/<version>\(.*\)<\/version>/\1/')
                   NEW_VERSION=$(echo $VERSION | awk -F. -v OFS=. '{$NF++;print}')
                   sed -i "s/<version>$VERSION<\/version>/<version>$NEW_VERSION<\/version>/" pom.xml
            - name: Build with Maven and Deploy
              run: mvn deploy --settings settings.xml
              env:
                NEXUS_USER: ${{ secrets.NEXUS_USER }}
                NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
                DISTRIBUTION_URL: ${{ secrets.DISTRIBUTION_URL }}